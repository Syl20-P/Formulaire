<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Valise Equipements</title>
</head>
<body>
<h2>Valise - Déplacement Equipements</h2>

<form id="valiseForm">
  <label>Origine :</label>
  <select id="origine" required></select><br><br>

  <label>Destination :</label>
  <select id="destination" required></select><br><br>

  <h3>Équipements dans la valise :</h3>
  <div id="equipementsContainer"></div>

  <button type="submit">Envoyer</button>
</form>

<script>
const webhookURL = "https://ton-n8n-instance.com/webhook/valise-form"; 
const equipmentsWebhookURL = "https://n8n.srv1108117.hstgr.cloud/webhook/get-equipements"; 

async function fetchEquipments() {
  try {
    const response = await fetch(equipmentsWebhookURL);
    const data = await response.json();
    return Array.isArray(data) ? data : [];
  } catch (err) {
    console.error("Erreur fetch équipements :", err);
    return [];
  }
}

async function initForm() {
  const equipments = await fetchEquipments();

  const locationsSet = new Set(
    equipments.map(e => e.property_location).filter(loc => loc)
  );
  const origineSelect = document.getElementById("origine");
  const destinationSelect = document.getElementById("destination");
  locationsSet.forEach(loc => {
    const o = document.createElement("option"); o.value = loc; o.textContent = loc;
    const d = document.createElement("option"); d.value = loc; d.textContent = loc;
    origineSelect.appendChild(o);
    destinationSelect.appendChild(d);
  });

  const container = document.getElementById("equipementsContainer");
  equipments.forEach(e => {
    if(e.name) {
      const div = document.createElement("div");
      div.innerHTML = `
        <input type="checkbox" name="equipement" value="${e.name}" id="${e.name}">
        <label for="${e.name}">${e.name}</label>
        Quantité: <input type="number" name="qty_${e.name}" min="0" value="0" disabled>
      `;
      container.appendChild(div);

      // Activation du champ quantité uniquement si la case est cochée
      const checkbox = div.querySelector(`input[name="equipement"]`);
      const qtyInput = div.querySelector(`input[type="number"]`);
      checkbox.addEventListener("change", () => {
        qtyInput.disabled = !checkbox.checked;
        if(!checkbox.checked) qtyInput.value = 0; // reset à 0 si décoché
      });
    }
  });
}

document.getElementById("valiseForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const origine = document.getElementById("origine").value;
  const destination = document.getElementById("destination").value;

  const formData = [];
  document.querySelectorAll("input[name='equipement']").forEach(checkbox => {
    if (checkbox.checked) {
      const qty = parseInt(document.querySelector(`input[name="qty_${checkbox.value}"]`).value) || 0;
      formData.push({
        equipement: checkbox.value,
        quantite: qty,
        origine,
        destination
      });
    }
  });

  if(formData.length === 0) {
    alert("Veuillez cocher au moins un équipement.");
    return;
  }

  try {
    const response = await fetch(webhookURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });
    if(response.ok) alert("Valise envoyée !");
    else alert("Erreur lors de l'envoi");
  } catch(err) {
    console.error("Erreur envoi webhook :", err);
    alert("Erreur lors de l'envoi");
  }
});

initForm();
</script>
</body>
</html>
