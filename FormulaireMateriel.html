<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Valise - Déplacement Équipements</title>

<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: auto;
  }
  .equipement {
    margin-bottom: 6px;
  }
  .qty {
    display: none;
    width: 60px;
    margin-left: 10px;
  }
</style>
</head>

<body>

<h2>Valise – Déplacement Équipements</h2>

<form id="valiseForm">

  <label>Origine :</label>
  <select id="origine" required></select>

  <br><br>

  <label>Destination :</label>
  <select id="destination" required></select>

  <br><br>

  <h3>Équipements dans la valise</h3>
  <div id="equipementsContainer"></div>

  <br>
  <button type="submit">Envoyer</button>
</form>

<script>
/* ===============================
   CONFIG
================================ */
const WEBHOOK_SUBMIT = "https://ton-n8n-instance.com/webhook/valise-form";
const WEBHOOK_GET_EQUIP = "https://n8n.srv1108117.hstgr.cloud/webhook/get-equipements";

/* ===============================
   FETCH EQUIPEMENTS
================================ */
async function fetchEquipments() {
  const response = await fetch(WEBHOOK_GET_EQUIP);
  return await response.json();
}

/* ===============================
   INITIALISATION FORMULAIRE
================================ */
async function initForm() {
  const equipments = await fetchEquipments();

  // --- Locations uniques ---
  const locations = [...new Set(
    equipments
      .map(e => e.property_location)
      .filter(l => l)
  )];

  const origineSelect = document.getElementById("origine");
  const destinationSelect = document.getElementById("destination");

  locations.forEach(loc => {
    origineSelect.add(new Option(loc, loc));
    destinationSelect.add(new Option(loc, loc));
  });

  // --- Liste équipements ---
  const container = document.getElementById("equipementsContainer");

  equipments
    .filter(e => e.name && e.property_location)
    .forEach(e => {
      const safeId = e.name.replace(/[^a-zA-Z0-9]/g, "_");

      const div = document.createElement("div");
      div.className = "equipement";

      div.innerHTML = `
        <input type="checkbox" id="chk_${safeId}">
        <label for="chk_${safeId}">${e.name}</label>

        <input
          type="number"
          id="qty_${safeId}"
          class="qty"
          min="1"
          value="1"
        >
      `;

      const checkbox = div.querySelector(`#chk_${safeId}`);
      const qtyInput = div.querySelector(`#qty_${safeId}`);

      checkbox.addEventListener("change", () => {
        qtyInput.style.display = checkbox.checked ? "inline-block" : "none";
        if (!checkbox.checked) qtyInput.value = 1;
      });

      container.appendChild(div);
    });
}

initForm();

/* ===============================
   ENVOI FORMULAIRE
================================ */
document.getElementById("valiseForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const origine = document.getElementById("origine").value;
  const destination = document.getElementById("destination").value;

  const payload = [];

  document.querySelectorAll("input[type='checkbox']").forEach(cb => {
    if (cb.checked) {
      const id = cb.id.replace("chk_", "");
      const qty = parseInt(document.getElementById(`qty_${id}`).value);

      payload.push({
        equipement: cb.nextElementSibling.textContent,
        quantite: qty,
        origine,
        destination
      });
    }
  });

  if (payload.length === 0) {
    alert("Aucun équipement sélectionné");
    return;
  }

  const response = await fetch(WEBHOOK_SUBMIT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  response.ok
    ? alert("Valise envoyée avec succès")
    : alert("Erreur lors de l'envoi");
});
</script>

</body>
</html>
